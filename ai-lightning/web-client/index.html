<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LightPhon ‚ö°</title>
    <link rel="stylesheet" href="style.css">
    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header id="header">
            <div class="header-main">
                <h1>‚ö° LightPhon</h1>
                <p class="tagline">Decentralized LLMs with Lightning payments</p>
            </div>
            <nav class="header-nav">
                <a href="#" onclick="showAboutModal(); return false;">About</a>
                <a href="#" onclick="showHowItWorksModal(); return false;">How it Works</a>
                <a href="#" onclick="showBecomeNodeModal(); return false;">Become a Node</a>
            </nav>
            <div id="network-status">
                <span class="status-dot"></span>
                <span id="nodes-count">Loading...</span>
            </div>
        </header>

        <!-- Auth Section -->
        <div id="auth-section">
            <div id="login-form" class="auth-form">
                <h2>Login</h2>
                <input type="text" id="username" placeholder="Username" autocomplete="username">
                <input type="password" id="password" placeholder="Password" autocomplete="current-password">
                <button onclick="login()">Login</button>
                <p>No account? <a href="#" onclick="showRegister()">Register</a></p>
            </div>
            <div id="register-form" class="auth-form" style="display: none;">
                <h2>Register</h2>
                <input type="text" id="reg-username" placeholder="Username" autocomplete="username">
                <input type="password" id="reg-password" placeholder="Password (min 8 chars)" autocomplete="new-password">
                <button onclick="register()">Register</button>
                <p>Have an account? <a href="#" onclick="showLoginForm()">Login</a></p>
            </div>
        </div>

        <!-- Main Section -->
        <div id="main-section" style="display: none;">
            <!-- User Info Bar -->
            <div id="user-bar">
                <div class="user-left">
                    <span id="user-info">Welcome!</span>
                </div>
                <div class="user-right">
                    <span id="user-balance" class="balance-display">‚ö° <span id="balance-amount">0</span> sats</span>
                    <button onclick="addTestBalance()" class="btn-small btn-balance" title="Add test balance">+üí∞</button>
                    <button onclick="logout()" class="btn-small">Logout</button>
                </div>
            </div>

            <!-- Models Section -->
            <div id="models-section">
                <h3>üß† Available Models</h3>
                <div id="models-loading" class="loading-spinner">Loading models from network...</div>
                <div id="models-grid"></div>
                <button onclick="refreshModels()" class="btn-refresh">üîÑ Refresh</button>
            </div>

            <!-- Session Config -->
            <div id="session-config" style="display: none;">
                <h3>‚öôÔ∏è Session Configuration</h3>
                <div class="config-row">
                    <label>Selected Model:</label>
                    <span id="selected-model-name">-</span>
                </div>
                <div class="config-row">
                    <label for="minutes">Duration (minutes):</label>
                    <input type="number" id="minutes" value="5" min="1" max="120">
                </div>
                <div class="config-row">
                    <label>Estimated Cost:</label>
                    <span id="estimated-cost">-</span>
                </div>
                
                <!-- Context Length Slider -->
                <div class="config-row context-row">
                    <label for="context-slider">Context Length:</label>
                    <div class="context-slider-container">
                        <input type="range" id="context-slider" min="512" max="32768" step="512" value="4096">
                        <span id="context-value" class="slider-value">4096</span>
                    </div>
                </div>
                
                <div class="session-buttons">
                    <button onclick="createSession()" class="btn-primary">‚ö° Buy Session</button>
                    <button onclick="openLLMSettings()" class="btn-settings" title="LLM Generation Settings">üéõÔ∏è Settings</button>
                    <button onclick="cancelModelSelection()" class="btn-secondary">Cancel</button>
                </div>
            </div>

            <!-- LLM Settings Modal -->
            <div id="llm-settings-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üéõÔ∏è LLM Generation Settings</h3>
                        <button onclick="closeLLMSettings()" class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <!-- Sampling Parameters -->
                        <div class="settings-section">
                            <h4>üé≤ Sampling</h4>
                            <div class="params-grid">
                                <div class="param-group">
                                    <label>Temperature</label>
                                    <input type="range" id="param-temperature" min="0" max="2" step="0.05" value="0.7">
                                    <span class="param-value" id="temp-value">0.7</span>
                                    <small>Randomness (0 = deterministic)</small>
                                </div>
                                <div class="param-group">
                                    <label>Dynamic Temp Range</label>
                                    <input type="range" id="param-dynatemp-range" min="0" max="2" step="0.1" value="0">
                                    <span class="param-value" id="dynatemp-range-value">0</span>
                                    <small>0 = disabled</small>
                                </div>
                                <div class="param-group">
                                    <label>Dynamic Temp Exponent</label>
                                    <input type="range" id="param-dynatemp-exp" min="0.1" max="3" step="0.1" value="1">
                                    <span class="param-value" id="dynatemp-exp-value">1</span>
                                </div>
                                <div class="param-group">
                                    <label>Top K</label>
                                    <input type="range" id="param-top-k" min="0" max="100" step="1" value="40">
                                    <span class="param-value" id="topk-value">40</span>
                                    <small>0 = disabled</small>
                                </div>
                                <div class="param-group">
                                    <label>Top P (Nucleus)</label>
                                    <input type="range" id="param-top-p" min="0" max="1" step="0.01" value="0.95">
                                    <span class="param-value" id="topp-value">0.95</span>
                                </div>
                                <div class="param-group">
                                    <label>Min P</label>
                                    <input type="range" id="param-min-p" min="0" max="1" step="0.01" value="0.05">
                                    <span class="param-value" id="minp-value">0.05</span>
                                </div>
                                <div class="param-group">
                                    <label>Typical P</label>
                                    <input type="range" id="param-typical-p" min="0" max="1" step="0.01" value="1">
                                    <span class="param-value" id="typicalp-value">1</span>
                                    <small>1 = disabled</small>
                                </div>
                                <div class="param-group">
                                    <label>XTC Threshold</label>
                                    <input type="range" id="param-xtc-threshold" min="0" max="1" step="0.01" value="0.1">
                                    <span class="param-value" id="xtc-threshold-value">0.1</span>
                                </div>
                                <div class="param-group">
                                    <label>XTC Probability</label>
                                    <input type="range" id="param-xtc-prob" min="0" max="1" step="0.01" value="0.5">
                                    <span class="param-value" id="xtc-prob-value">0.5</span>
                                </div>
                            </div>
                        </div>

                        <!-- Penalties -->
                        <div class="settings-section">
                            <h4>‚öñÔ∏è Penalties</h4>
                            <div class="params-grid">
                                <div class="param-group">
                                    <label>Repeat Last N</label>
                                    <input type="number" id="param-repeat-last-n" min="0" max="2048" value="64">
                                    <small>Tokens to consider for repeat penalty</small>
                                </div>
                                <div class="param-group">
                                    <label>Repeat Penalty</label>
                                    <input type="range" id="param-repeat-penalty" min="1" max="2" step="0.01" value="1">
                                    <span class="param-value" id="repeat-value">1</span>
                                    <small>1 = no penalty</small>
                                </div>
                                <div class="param-group">
                                    <label>Presence Penalty</label>
                                    <input type="range" id="param-presence-penalty" min="-2" max="2" step="0.1" value="0">
                                    <span class="param-value" id="presence-value">0</span>
                                </div>
                                <div class="param-group">
                                    <label>Frequency Penalty</label>
                                    <input type="range" id="param-frequency-penalty" min="-2" max="2" step="0.1" value="0">
                                    <span class="param-value" id="frequency-value">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- DRY Parameters -->
                        <div class="settings-section">
                            <h4>üèúÔ∏è DRY (Don't Repeat Yourself)</h4>
                            <div class="params-grid">
                                <div class="param-group">
                                    <label>DRY Multiplier</label>
                                    <input type="range" id="param-dry-multiplier" min="0" max="2" step="0.1" value="0">
                                    <span class="param-value" id="dry-mult-value">0</span>
                                    <small>0 = disabled</small>
                                </div>
                                <div class="param-group">
                                    <label>DRY Base</label>
                                    <input type="range" id="param-dry-base" min="1" max="3" step="0.05" value="1.75">
                                    <span class="param-value" id="dry-base-value">1.75</span>
                                </div>
                                <div class="param-group">
                                    <label>DRY Allowed Length</label>
                                    <input type="number" id="param-dry-allowed-length" min="1" max="10" value="2">
                                </div>
                                <div class="param-group">
                                    <label>DRY Penalty Last N</label>
                                    <input type="number" id="param-dry-penalty-last-n" min="-1" max="2048" value="-1">
                                    <small>-1 = context size</small>
                                </div>
                            </div>
                        </div>

                        <!-- Generation -->
                        <div class="settings-section">
                            <h4>üìù Generation</h4>
                            <div class="params-grid">
                                <div class="param-group">
                                    <label>Max Tokens</label>
                                    <input type="number" id="param-max-tokens" min="-1" max="32768" value="-1">
                                    <small>-1 = use model's context</small>
                                </div>
                                <div class="param-group">
                                    <label>Seed</label>
                                    <input type="number" id="param-seed" min="-1" value="-1">
                                    <small>-1 = random</small>
                                </div>
                            </div>
                        </div>

                        <!-- Sampler Order -->
                        <div class="settings-section">
                            <h4>üìã Sampler Order</h4>
                            <div class="param-group full-width">
                                <label>Order of application</label>
                                <input type="text" id="param-samplers" value="penalties;dry;top_k;typical_p;top_p;min_p;xtc;temperature" class="text-input-wide">
                                <small>Semicolon-separated list: penalties, dry, top_k, typical_p, top_p, min_p, xtc, temperature</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="resetLLMParams()" class="btn-secondary">‚Ü∫ Reset Defaults</button>
                        <button onclick="closeLLMSettings()" class="btn-primary">‚úì Apply</button>
                    </div>
                </div>
            </div>

            <!-- Invoice Section -->
            <div id="invoice-section" style="display: none;">
                <h3>üí≥ Payment Required</h3>
                <p>Pay this Lightning invoice to start your session:</p>
                
                <!-- QR Code -->
                <div id="qr-container">
                    <canvas id="qr-code"></canvas>
                </div>
                
                <!-- Invoice String -->
                <div id="invoice-container">
                    <pre id="invoice"></pre>
                    <div class="invoice-buttons">
                        <button onclick="copyInvoice()" class="btn-small">üìã Copy Invoice</button>
                        <button onclick="openInWallet()" class="btn-small btn-lightning">‚ö° Open in Wallet</button>
                    </div>
                </div>
                
                <p class="invoice-amount">Amount: <span id="invoice-amount">-</span> sats</p>
                <p class="invoice-hint">Scan QR code with your Lightning wallet or click "Open in Wallet"</p>
                
                <div class="payment-buttons">
                    <button onclick="checkPayment()" class="btn-primary">‚úì I've Paid</button>
                    <button onclick="cancelPayment()" class="btn-secondary">Cancel</button>
                </div>
            </div>

            <!-- Chat Section -->
            <div id="chat-section" style="display: none;">
                <div id="session-info">
                    <span id="session-model">-</span>
                    <button onclick="openLLMSettings()" class="btn-icon" title="LLM Settings">‚öôÔ∏è</button>
                    <span id="session-expires">-</span>
                    <button onclick="endSession()" class="btn-small btn-danger">End Session</button>
                </div>
                
                <div class="chat-container" id="chat">
                    <div class="message system">Session ready! Start chatting.</div>
                </div>

                <div class="input-area">
                    <input type="text" id="prompt" placeholder="Type your message..." disabled
                           onkeypress="if(event.key=='Enter') sendMessage()">
                    <button id="send-btn" onclick="sendMessage()" disabled>Send</button>
                </div>
            </div>

            <!-- Network Info Panel -->
            <div id="network-panel">
                <h3>üìä Network Status</h3>
                <div id="network-info">
                    <div class="info-item">
                        <span class="label">Online Nodes:</span>
                        <span id="total-nodes">0</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Available Models:</span>
                        <span id="total-models">0</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Total VRAM:</span>
                        <span id="total-vram">0 GB</span>
                    </div>
                </div>
                <button onclick="showNodesInfo()" class="btn-small">View Nodes</button>
            </div>
        </div>

        <!-- Nodes Modal -->
        <div id="nodes-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeNodesModal()">&times;</span>
                <h3>üñ•Ô∏è Online Nodes</h3>
                <div id="nodes-list"></div>
            </div>
        </div>

        <!-- About Modal -->
        <div id="about-modal" class="modal" style="display: none;">
            <div class="modal-content modal-info">
                <span class="close" onclick="closeModal('about-modal')">&times;</span>
                <h3>‚ö° About LightPhon</h3>
                <div class="modal-body">
                    <p><strong>LightPhon</strong> is a decentralized AI marketplace that connects users with GPU providers worldwide. Access powerful Large Language Models (LLMs) and pay only for what you use with instant Bitcoin Lightning payments.</p>
                    
                    <h4>üéØ Our Mission</h4>
                    <p>Make AI accessible to everyone while creating a fair marketplace where GPU owners can monetize their hardware and users get affordable, private AI access.</p>
                    
                    <h4>‚ú® Key Features</h4>
                    <ul>
                        <li><strong>Decentralized:</strong> No single point of failure, censorship-resistant</li>
                        <li><strong>Pay-per-use:</strong> Only pay for the time you actually use</li>
                        <li><strong>Privacy-first:</strong> Your conversations stay between you and the node</li>
                        <li><strong>Open source:</strong> Transparent and community-driven</li>
                        <li><strong>Lightning fast:</strong> Instant payments, instant access</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- How it Works Modal -->
        <div id="howitworks-modal" class="modal" style="display: none;">
            <div class="modal-content modal-info">
                <span class="close" onclick="closeModal('howitworks-modal')">&times;</span>
                <h3>üîÑ How it Works</h3>
                <div class="modal-body">
                    <div class="steps">
                        <div class="step">
                            <span class="step-num">1</span>
                            <h4>Choose a Model</h4>
                            <p>Browse available AI models from our network of GPU providers. See specs, pricing, and capabilities.</p>
                        </div>
                        <div class="step">
                            <span class="step-num">2</span>
                            <h4>Pay with Lightning</h4>
                            <p>Create a session and pay the invoice with any Lightning wallet. Payments are instant and final.</p>
                        </div>
                        <div class="step">
                            <span class="step-num">3</span>
                            <h4>Start Chatting</h4>
                            <p>Once paid, the model loads on the node's GPU. Chat directly with no intermediaries.</p>
                        </div>
                        <div class="step">
                            <span class="step-num">4</span>
                            <h4>Session Ends</h4>
                            <p>When time expires or you end the session, the model is unloaded. No data is stored.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Become a Node Modal -->
        <div id="becomenode-modal" class="modal" style="display: none;">
            <div class="modal-content modal-info">
                <span class="close" onclick="closeModal('becomenode-modal')">&times;</span>
                <h3>üñ•Ô∏è Become a Node Provider</h3>
                <div class="modal-body">
                    <p>Have a powerful GPU? Join the LightPhon network and earn Bitcoin by providing AI inference services!</p>
                    
                    <h4>üìã Requirements</h4>
                    <ul>
                        <li><strong>GPU:</strong> NVIDIA GPU with 8GB+ VRAM (RTX 3080, 4090, etc.)</li>
                        <li><strong>RAM:</strong> 16GB+ system memory</li>
                        <li><strong>Internet:</strong> Stable connection with good upload speed</li>
                        <li><strong>Software:</strong> llama.cpp with llama-server</li>
                    </ul>
                    
                    <h4>üí∞ Earnings</h4>
                    <p>You set your own price per minute. Popular rates are 50-200 sats/min depending on GPU power and model size.</p>
                    
                    <h4>üöÄ Getting Started</h4>
                    <ol>
                        <li>Download the Node Client from our <a href="https://github.com/ddorigoddorigo/AI-Lightning" target="_blank">GitHub</a></li>
                        <li>Install llama.cpp and llama-server</li>
                        <li>Configure your models and pricing</li>
                        <li>Run the node client and start earning!</li>
                    </ol>
                    
                    <div class="cta-box">
                        <a href="https://github.com/ddorigoddorigo/AI-Lightning" target="_blank" class="btn-primary">üì• Download Node Client</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer id="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>‚ö° LightPhon</h4>
                <p>Decentralized AI powered by Bitcoin Lightning Network. Access LLMs privately, pay only for what you use.</p>
            </div>
            <div class="footer-section">
                <h4>Links</h4>
                <ul>
                    <li><a href="#" onclick="showAboutModal(); return false;">About Us</a></li>
                    <li><a href="#" onclick="showHowItWorksModal(); return false;">How it Works</a></li>
                    <li><a href="#" onclick="showBecomeNodeModal(); return false;">Become a Node</a></li>
                    <li><a href="https://github.com/ddorigoddorigo/AI-Lightning" target="_blank">GitHub</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Technology</h4>
                <ul>
                    <li>üß† llama.cpp</li>
                    <li>‚ö° Lightning Network</li>
                    <li>üîó Socket.IO</li>
                    <li>üêç Python + Flask</li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Contact</h4>
                <p>Open source project</p>
                <p><a href="https://github.com/ddorigoddorigo/AI-Lightning/issues" target="_blank">Report Issues</a></p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>¬© 2026 LightPhon - Open Source under MIT License</p>
            <p class="footer-tagline">üåê Decentralized ‚Ä¢ ‚ö° Instant ‚Ä¢ üîí Private</p>
        </div>
    </footer>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="script.js"></script>
</body>
</html>