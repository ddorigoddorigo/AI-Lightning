<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LightPhon ‚ö°</title>
    <link rel="stylesheet" href="style.css">
    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header id="header">
            <h1>‚ö° LightPhon</h1>
            <p class="tagline">Decentralized LLMs with Lightning payments</p>
            <div id="network-status">
                <span class="status-dot"></span>
                <span id="nodes-count">Loading...</span>
            </div>
        </header>

        <!-- Auth Section -->
        <div id="auth-section">
            <div id="login-form" class="auth-form">
                <h2>Login</h2>
                <input type="text" id="username" placeholder="Username" autocomplete="username">
                <input type="password" id="password" placeholder="Password" autocomplete="current-password">
                <button onclick="login()">Login</button>
                <p>No account? <a href="#" onclick="showRegister()">Register</a></p>
            </div>
            <div id="register-form" class="auth-form" style="display: none;">
                <h2>Register</h2>
                <input type="text" id="reg-username" placeholder="Username" autocomplete="username">
                <input type="password" id="reg-password" placeholder="Password (min 8 chars)" autocomplete="new-password">
                <button onclick="register()">Register</button>
                <p>Have an account? <a href="#" onclick="showLoginForm()">Login</a></p>
            </div>
        </div>

        <!-- Main Section -->
        <div id="main-section" style="display: none;">
            <!-- User Info Bar -->
            <div id="user-bar">
                <div class="user-left">
                    <span id="user-info">Welcome!</span>
                </div>
                <div class="user-right">
                    <span id="user-balance" class="balance-display">‚ö° <span id="balance-amount">0</span> sats</span>
                    <button onclick="addTestBalance()" class="btn-small btn-balance" title="Add test balance">+üí∞</button>
                    <button onclick="logout()" class="btn-small">Logout</button>
                </div>
            </div>

            <!-- Models Section -->
            <div id="models-section">
                <h3>üß† Available Models</h3>
                <div id="models-loading" class="loading-spinner">Loading models from network...</div>
                <div id="models-grid"></div>
                <button onclick="refreshModels()" class="btn-refresh">üîÑ Refresh</button>
            </div>

            <!-- Session Config -->
            <div id="session-config" style="display: none;">
                <h3>‚öôÔ∏è Session Configuration</h3>
                <div class="config-row">
                    <label>Selected Model:</label>
                    <span id="selected-model-name">-</span>
                </div>
                <div class="config-row">
                    <label for="minutes">Duration (minutes):</label>
                    <input type="number" id="minutes" value="5" min="1" max="120">
                </div>
                <div class="config-row">
                    <label>Estimated Cost:</label>
                    <span id="estimated-cost">-</span>
                </div>
                <button onclick="createSession()" class="btn-primary">‚ö° Buy Session</button>
                <button onclick="cancelModelSelection()" class="btn-secondary">Cancel</button>
            </div>

            <!-- Invoice Section -->
            <div id="invoice-section" style="display: none;">
                <h3>üí≥ Payment Required</h3>
                <p>Pay this Lightning invoice to start your session:</p>
                
                <!-- QR Code -->
                <div id="qr-container">
                    <canvas id="qr-code"></canvas>
                </div>
                
                <!-- Invoice String -->
                <div id="invoice-container">
                    <pre id="invoice"></pre>
                    <div class="invoice-buttons">
                        <button onclick="copyInvoice()" class="btn-small">üìã Copy Invoice</button>
                        <button onclick="openInWallet()" class="btn-small btn-lightning">‚ö° Open in Wallet</button>
                    </div>
                </div>
                
                <p class="invoice-amount">Amount: <span id="invoice-amount">-</span> sats</p>
                <p class="invoice-hint">Scan QR code with your Lightning wallet or click "Open in Wallet"</p>
                
                <div class="payment-buttons">
                    <button onclick="checkPayment()" class="btn-primary">‚úì I've Paid</button>
                    <button onclick="cancelPayment()" class="btn-secondary">Cancel</button>
                </div>
            </div>

            <!-- Chat Section -->
            <div id="chat-section" style="display: none;">
                <div id="session-info">
                    <span id="session-model">-</span>
                    <span id="session-expires">-</span>
                    <button onclick="endSession()" class="btn-small btn-danger">End Session</button>
                </div>
                
                <div class="chat-container" id="chat">
                    <div class="message system">Session ready! Start chatting.</div>
                </div>

                <div class="input-area">
                    <input type="text" id="prompt" placeholder="Type your message..." disabled
                           onkeypress="if(event.key=='Enter') sendMessage()">
                    <button id="send-btn" onclick="sendMessage()" disabled>Send</button>
                </div>
            </div>

            <!-- Network Info Panel -->
            <div id="network-panel">
                <h3>üìä Network Status</h3>
                <div id="network-info">
                    <div class="info-item">
                        <span class="label">Online Nodes:</span>
                        <span id="total-nodes">0</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Available Models:</span>
                        <span id="total-models">0</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Total VRAM:</span>
                        <span id="total-vram">0 GB</span>
                    </div>
                </div>
                <button onclick="showNodesInfo()" class="btn-small">View Nodes</button>
            </div>
        </div>

        <!-- Nodes Modal -->
        <div id="nodes-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeNodesModal()">&times;</span>
                <h3>üñ•Ô∏è Online Nodes</h3>
                <div id="nodes-list"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="script.js"></script>
</body>
</html>