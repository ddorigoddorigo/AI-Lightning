<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LightPhon ‚ö°</title>
    <link rel="stylesheet" href="style.css">
    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header id="header">
            <h1>‚ö° LightPhon</h1>
            <p class="tagline">Decentralized LLMs with Lightning payments</p>
            <div id="network-status">
                <span class="status-dot"></span>
                <span id="nodes-count">Loading...</span>
            </div>
        </header>

        <!-- Auth Section -->
        <div id="auth-section">
            <div id="login-form" class="auth-form">
                <h2>Login</h2>
                <input type="text" id="username" placeholder="Username" autocomplete="username">
                <input type="password" id="password" placeholder="Password" autocomplete="current-password">
                <button onclick="login()">Login</button>
                <p>No account? <a href="#" onclick="showRegister()">Register</a></p>
            </div>
            <div id="register-form" class="auth-form" style="display: none;">
                <h2>Register</h2>
                <input type="text" id="reg-username" placeholder="Username" autocomplete="username">
                <input type="password" id="reg-password" placeholder="Password (min 8 chars)" autocomplete="new-password">
                <button onclick="register()">Register</button>
                <p>Have an account? <a href="#" onclick="showLoginForm()">Login</a></p>
            </div>
        </div>

        <!-- Main Section -->
        <div id="main-section" style="display: none;">
            <!-- User Info Bar -->
            <div id="user-bar">
                <div class="user-left">
                    <span id="user-info">Welcome!</span>
                </div>
                <div class="user-right">
                    <span id="user-balance" class="balance-display">‚ö° <span id="balance-amount">0</span> sats</span>
                    <button onclick="addTestBalance()" class="btn-small btn-balance" title="Add test balance">+üí∞</button>
                    <button onclick="logout()" class="btn-small">Logout</button>
                </div>
            </div>

            <!-- Models Section -->
            <div id="models-section">
                <h3>üß† Available Models</h3>
                <div id="models-loading" class="loading-spinner">Loading models from network...</div>
                <div id="models-grid"></div>
                <button onclick="refreshModels()" class="btn-refresh">üîÑ Refresh</button>
            </div>

            <!-- Session Config -->
            <div id="session-config" style="display: none;">
                <h3>‚öôÔ∏è Session Configuration</h3>
                <div class="config-row">
                    <label>Selected Model:</label>
                    <span id="selected-model-name">-</span>
                    <button onclick="openLLMSettings()" class="btn-icon" title="LLM Settings">‚öôÔ∏è</button>
                </div>
                <div class="config-row">
                    <label for="minutes">Duration (minutes):</label>
                    <input type="number" id="minutes" value="5" min="1" max="120">
                </div>
                <div class="config-row">
                    <label>Estimated Cost:</label>
                    <span id="estimated-cost">-</span>
                </div>
                
                <button onclick="createSession()" class="btn-primary">‚ö° Buy Session</button>
                <button onclick="cancelModelSelection()" class="btn-secondary">Cancel</button>
            </div>

            <!-- LLM Settings Modal -->
            <div id="llm-settings-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üéõÔ∏è LLM Generation Settings</h3>
                        <button onclick="closeLLMSettings()" class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <!-- Sampling Parameters -->
                        <div class="settings-section">
                            <h4>üé≤ Sampling</h4>
                            <div class="params-grid">
                                <div class="param-group">
                                    <label>Temperature</label>
                                    <input type="range" id="param-temperature" min="0" max="2" step="0.05" value="0.7">
                                    <span class="param-value" id="temp-value">0.7</span>
                                    <small>Randomness (0 = deterministic)</small>
                                </div>
                                <div class="param-group">
                                    <label>Dynamic Temp Range</label>
                                    <input type="range" id="param-dynatemp-range" min="0" max="2" step="0.1" value="0">
                                    <span class="param-value" id="dynatemp-range-value">0</span>
                                    <small>0 = disabled</small>
                                </div>
                                <div class="param-group">
                                    <label>Dynamic Temp Exponent</label>
                                    <input type="range" id="param-dynatemp-exp" min="0.1" max="3" step="0.1" value="1">
                                    <span class="param-value" id="dynatemp-exp-value">1</span>
                                </div>
                                <div class="param-group">
                                    <label>Top K</label>
                                    <input type="range" id="param-top-k" min="0" max="100" step="1" value="40">
                                    <span class="param-value" id="topk-value">40</span>
                                    <small>0 = disabled</small>
                                </div>
                                <div class="param-group">
                                    <label>Top P (Nucleus)</label>
                                    <input type="range" id="param-top-p" min="0" max="1" step="0.01" value="0.95">
                                    <span class="param-value" id="topp-value">0.95</span>
                                </div>
                                <div class="param-group">
                                    <label>Min P</label>
                                    <input type="range" id="param-min-p" min="0" max="1" step="0.01" value="0.05">
                                    <span class="param-value" id="minp-value">0.05</span>
                                </div>
                                <div class="param-group">
                                    <label>Typical P</label>
                                    <input type="range" id="param-typical-p" min="0" max="1" step="0.01" value="1">
                                    <span class="param-value" id="typicalp-value">1</span>
                                    <small>1 = disabled</small>
                                </div>
                                <div class="param-group">
                                    <label>XTC Threshold</label>
                                    <input type="range" id="param-xtc-threshold" min="0" max="1" step="0.01" value="0.1">
                                    <span class="param-value" id="xtc-threshold-value">0.1</span>
                                </div>
                                <div class="param-group">
                                    <label>XTC Probability</label>
                                    <input type="range" id="param-xtc-prob" min="0" max="1" step="0.01" value="0.5">
                                    <span class="param-value" id="xtc-prob-value">0.5</span>
                                </div>
                            </div>
                        </div>

                        <!-- Penalties -->
                        <div class="settings-section">
                            <h4>‚öñÔ∏è Penalties</h4>
                            <div class="params-grid">
                                <div class="param-group">
                                    <label>Repeat Last N</label>
                                    <input type="number" id="param-repeat-last-n" min="0" max="2048" value="64">
                                    <small>Tokens to consider for repeat penalty</small>
                                </div>
                                <div class="param-group">
                                    <label>Repeat Penalty</label>
                                    <input type="range" id="param-repeat-penalty" min="1" max="2" step="0.01" value="1">
                                    <span class="param-value" id="repeat-value">1</span>
                                    <small>1 = no penalty</small>
                                </div>
                                <div class="param-group">
                                    <label>Presence Penalty</label>
                                    <input type="range" id="param-presence-penalty" min="-2" max="2" step="0.1" value="0">
                                    <span class="param-value" id="presence-value">0</span>
                                </div>
                                <div class="param-group">
                                    <label>Frequency Penalty</label>
                                    <input type="range" id="param-frequency-penalty" min="-2" max="2" step="0.1" value="0">
                                    <span class="param-value" id="frequency-value">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- DRY Parameters -->
                        <div class="settings-section">
                            <h4>üèúÔ∏è DRY (Don't Repeat Yourself)</h4>
                            <div class="params-grid">
                                <div class="param-group">
                                    <label>DRY Multiplier</label>
                                    <input type="range" id="param-dry-multiplier" min="0" max="2" step="0.1" value="0">
                                    <span class="param-value" id="dry-mult-value">0</span>
                                    <small>0 = disabled</small>
                                </div>
                                <div class="param-group">
                                    <label>DRY Base</label>
                                    <input type="range" id="param-dry-base" min="1" max="3" step="0.05" value="1.75">
                                    <span class="param-value" id="dry-base-value">1.75</span>
                                </div>
                                <div class="param-group">
                                    <label>DRY Allowed Length</label>
                                    <input type="number" id="param-dry-allowed-length" min="1" max="10" value="2">
                                </div>
                                <div class="param-group">
                                    <label>DRY Penalty Last N</label>
                                    <input type="number" id="param-dry-penalty-last-n" min="-1" max="2048" value="-1">
                                    <small>-1 = context size</small>
                                </div>
                            </div>
                        </div>

                        <!-- Generation -->
                        <div class="settings-section">
                            <h4>üìù Generation</h4>
                            <div class="params-grid">
                                <div class="param-group">
                                    <label>Max Tokens</label>
                                    <input type="number" id="param-max-tokens" min="-1" max="32768" value="-1">
                                    <small>-1 = use model's context</small>
                                </div>
                                <div class="param-group">
                                    <label>Seed</label>
                                    <input type="number" id="param-seed" min="-1" value="-1">
                                    <small>-1 = random</small>
                                </div>
                            </div>
                        </div>

                        <!-- Sampler Order -->
                        <div class="settings-section">
                            <h4>üìã Sampler Order</h4>
                            <div class="param-group full-width">
                                <label>Order of application</label>
                                <input type="text" id="param-samplers" value="penalties;dry;top_k;typical_p;top_p;min_p;xtc;temperature" class="text-input-wide">
                                <small>Semicolon-separated list: penalties, dry, top_k, typical_p, top_p, min_p, xtc, temperature</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="resetLLMParams()" class="btn-secondary">‚Ü∫ Reset Defaults</button>
                        <button onclick="closeLLMSettings()" class="btn-primary">‚úì Apply</button>
                    </div>
                </div>
            </div>

            <!-- Invoice Section -->
            <div id="invoice-section" style="display: none;">
                <h3>üí≥ Payment Required</h3>
                <p>Pay this Lightning invoice to start your session:</p>
                
                <!-- QR Code -->
                <div id="qr-container">
                    <canvas id="qr-code"></canvas>
                </div>
                
                <!-- Invoice String -->
                <div id="invoice-container">
                    <pre id="invoice"></pre>
                    <div class="invoice-buttons">
                        <button onclick="copyInvoice()" class="btn-small">üìã Copy Invoice</button>
                        <button onclick="openInWallet()" class="btn-small btn-lightning">‚ö° Open in Wallet</button>
                    </div>
                </div>
                
                <p class="invoice-amount">Amount: <span id="invoice-amount">-</span> sats</p>
                <p class="invoice-hint">Scan QR code with your Lightning wallet or click "Open in Wallet"</p>
                
                <div class="payment-buttons">
                    <button onclick="checkPayment()" class="btn-primary">‚úì I've Paid</button>
                    <button onclick="cancelPayment()" class="btn-secondary">Cancel</button>
                </div>
            </div>

            <!-- Chat Section -->
            <div id="chat-section" style="display: none;">
                <div id="session-info">
                    <span id="session-model">-</span>
                    <button onclick="openLLMSettings()" class="btn-icon" title="LLM Settings">‚öôÔ∏è</button>
                    <span id="session-expires">-</span>
                    <button onclick="endSession()" class="btn-small btn-danger">End Session</button>
                </div>
                
                <div class="chat-container" id="chat">
                    <div class="message system">Session ready! Start chatting.</div>
                </div>

                <div class="input-area">
                    <input type="text" id="prompt" placeholder="Type your message..." disabled
                           onkeypress="if(event.key=='Enter') sendMessage()">
                    <button id="send-btn" onclick="sendMessage()" disabled>Send</button>
                </div>
            </div>

            <!-- Network Info Panel -->
            <div id="network-panel">
                <h3>üìä Network Status</h3>
                <div id="network-info">
                    <div class="info-item">
                        <span class="label">Online Nodes:</span>
                        <span id="total-nodes">0</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Available Models:</span>
                        <span id="total-models">0</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Total VRAM:</span>
                        <span id="total-vram">0 GB</span>
                    </div>
                </div>
                <button onclick="showNodesInfo()" class="btn-small">View Nodes</button>
            </div>
        </div>

        <!-- Nodes Modal -->
        <div id="nodes-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeNodesModal()">&times;</span>
                <h3>üñ•Ô∏è Online Nodes</h3>
                <div id="nodes-list"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="script.js"></script>
</body>
</html>